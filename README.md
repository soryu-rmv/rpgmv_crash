# 作業中のRPGツクールMV強制終了によるデータ破損回避術

by 蒼竜 @soryu_rpmakermv

-------------------------------------------------

<br>

## 1. はじめに

RPGツクールMVは、2015年の発売当時からエディタの挙動に不安を覚える部分がある。  
マルチプラットフォーム化によるユーザーの裾野の広がりは歓迎されるべき点ではあるが、   
その代償として過去のツクールでは殆ど気にすることが無かった不具合も生まれている。

私が最も気にするものは、エディタの強制終了頻度の高さである。ツクールのエディタ上で扱える  
アイテムやスキル、アニメーションといったデータ数の上限は過去のツクールよりも引き下げられているが、  
実際にRPGツクールMVにおける上限いっぱいまでデータベースを作り込むと、頻繁に強制終了が起こる。   
特にプロジェクト保存時に起こる強制終了が最も痛ましく、最悪データベース用のデータを全壊させることがある。

![json](https://user-images.githubusercontent.com/64351233/80788333-c5b3cd00-8bc3-11ea-9d11-bd549341cf43.png)   

上図はプロジェクト保存時に強制終了が発生した上、アニメーションデータを保存するAnimations.jsonが     
破壊されてしまった時にRPGツクールMV起動時に表示されるダイアログである。この時、    
Animations.jsonは空ファイルになってしまっており、適当に修復しなければプロジェクトを再び開くことも不可能である。   
もちろんプロジェクトを開くことに成功したとしても、Animations.jsonのバックアップを事前にとっていなければ  
アニメーションデータの復活はまず不可能である。    

RPGツクールMVでは、プロジェクトを開いてから終了するまでの間、データベースやマップなどの情報が書かれたファイルを   
次々とメモリ上(ここで言うメモリは、RPGツクールMVが使うために割り当てられたメモリ領域)に展開していく。   
データベースファイルは、作業中に変更していなくともプロジェクト保存時に書き込まれる。     
もちろん、単に自分のパソコンのメモリを増やせば解決するなどということもない。恐らく何らかの不具合であると考えられる。
こういった挙動はもちろん有志のプラグインで変更することは不可能であるため、ツクール本体のアップデートを座して待つしかない。

発売から５年と少し待っていたが、ツクール開発の奔流はラノゲツクール、アクションゲームツクールと他方面へ向いてしまい   
自然とエディタの挙動周りにおける不具合が解決される望みは薄くなった。実際、本質的にほぼ同じなコンシューマ用移植作  
「RPGツクールMVTrinity」が発売されたが、個人的な予想通り、エディタの挙動に関する評判は決して芳しくなかった。

私はこれまで本作での作業中に、何度も突然の強制終了やデータのクラッシュによる多大な時間的損失を受けて、  
「RPGツクールMVでは本格的なRPGを作成してはならない」という啓示を受けたような気分で失意を感じたため   
不意の強制終了によるプロジェクト破壊を防止するためにRPGツクールMVでの作業中にできる自衛手段を検討した。


<br>

## 2. 強制終了が発生しうる状況
著者が遭遇した、RPGツクールMV強制終了が発生した主な瞬間を列挙する。

- 「プロジェクトの保存」を実行したとき
- データベースやイベント編集画面でOKを押したとき
- イベントの作成中 (イベントコマンド選択操作など)
- bgmフォルダに入れた楽曲を、サウンドテストで再生している状況下での作業

プロジェクト保存によるデータ破壊は以ての外であるが、イベント作成中の強制終了は  
作業データを退避させる暇もなく、作成したイベントが無に帰すため非常に厄介である。


<br>

## 3. 対策

### 3.1. 項目数の多いデータベースファイルを一時移動する

Animations.jsonの破損によく遭遇するというのならば、戦闘テストを必要としない作業をしている間は
RPGツクールMVに読み込ませるAnimations.jsonをわざと空にしてしまうという方法もある。    
ただし、はじめに述べたように**「全くの白紙」ではプロジェクトを起動できない**ので最小限の準備が必要である。  
以下は、空のAnimations.jsonを利用してエディタを開くまでの手順である。   

- 1. 現在のプロジェクトの ./data/Animations.json を適当に名前を変更する、あるいはコピーで別の場所へ退避
- 2. RPGツクールMVのデータベース上で、アニメーションを全て削除（空の状態にする）
- 3. プロジェクトを保存する（ここでRPGツクールMVを1度終了させておくとよい）
- 4. 実質的な空のAnimations.jsonを以後、バックアップとしておくために別の名前(Animations_.json等)へ変更する
- 5. RPGツクールMVを開き直す（ほぼ空のAnimations.jsonが読み込まれる）

<br>

![animations](https://user-images.githubusercontent.com/64351233/80791751-92763b80-8bcd-11ea-8d2e-072a3610efbc.png)

上図は実際の運用例である。   
Animations.jsonは、エディタ上で編集可能な1000データ全てを使い込むと、10MB近くになる。   
ところが会話イベントを作成する作業が目的ならば、（アニメーションの表示をしない限り）この作業にAnimations.jsonは必要ない。   
無駄に読み込ませてクラッシュされるぐらいなら、ほぼ空のデータを読み込ませておけば    
保存時のクラッシュのリスクが減るどころか、プロジェクトの起動時間も短くなる。  
 
戦闘テストを含めた通しプレイをする時は、ダミーとして用意した（ほぼ）空のAnimations.jsonを  
再度Animations_.json等にしておいて、**退避しておいた本物のAnimations.jsonを元に戻す（./data/に置く）**。　　　

<br>

バックアップを作成することを心掛けておくことはこういった制作作業においては当然気をつけるべきことだが、    
RPGツクールMVに関してはいささか性質が悪いので、   
（アニメーションデータが数個失われてしまっただけでも再現・復元、再作成は手間である）    
エディタをアテにしない自衛手段としては有効である。


<br>

なお、ダミーのAnimations.jsonを読み込んでツクールを起動している間は、
既にプロジェクト内で作成していたイベント内の「アニメーションの表示」における表示アニメーションは　　**？**　と   
なってしまっているが、表示させるアニメーションの情報は、各マップのデータを持つMapXXX.jsonファイルが記憶しているので    
Animations.jsonを元に戻せば直ちに復活する（ので、不安になって迂闊に触らないこと）。   



### 3.2. RPGツクールMV上でのBGMの再生を控える

ツクールのエディタ上（サウンドテスト）でBGMを再生すると、もちろん曲のデータもメモリに格納される。   
曲データのファイルサイズ(ビットレートや長さ)にもよるが、**長く壮大な曲はそもそも再生できていないこともある**。   
oggファイルのループ再生のチェックに有用ではあるが、再生しながらの作業継続は強制終了のリスクを高める。   

作業BGMとしての試聴など、再生だけが目的なら他のツールを使って再生させた方が安全である。


### 3.3. プロジェクト保存前の作成イベントのバックアップ

「保存したいが、保存するとクラッシュするかもしれない」となると、    
割としっかりとしたストーリー部分のイベントを書き上げた直後のプロジェクト保存には勇気が必要である。    

そこで、RPGツクールMVを**もう１つ起動する**という方法がある。    
開かれた直後のRPGツクールMVでいきなり強制終了してしまうということはまず起こらない。    
（もちろん、ツクール多重起動のためにPCそのもののメモリは必要なので、古いPC等の環境によっては厳しいかもしれないが…）   


まず、作業中のプロジェクトを新たに起動したRPGツクールMVで開いた状態にしておく。
下図では、もともと作業していたRPGMVを左側に、今新規に開いたRPGMVを右側に並べている。

![rpgmv](https://user-images.githubusercontent.com/64351233/80790807-be43f200-8bca-11ea-897c-4efac99e5442.png)

作成されているイベントは、なんと**ツクールのウィンドウやプロジェクトをまたいでコピー・ペーストできる**。     
しかも同じマップであってもなくてもよく、更には全く違うゲームに対してのペーストも可能である。

これを利用して、作業していたRPGMV画面から今作ったばかりのイベントをコピーする。   
ショートカットでCtrl+Cをしてもよいし、右クリック→コピーでもよい。   

コピーができたら、新たに立ち上げた方のRPGMV画面（もちろん、同じマップを開いていた方が良い）にペーストする。   
こちらもショートカットでCtrl+Vをしてもよいし、右クリック→ペーストでもよい。  

この状態で、もともと作業していたRPGMV側に戻って改めてプロジェクト保存を試みる。  
成功したなら、もうそれでもう一方は閉じてしまって構わないし、    
万が一強制終了になってしまったとしても、新たに開いておいたツクールに作成したイベントは生きているので、
精神的ダメージを受けずに保存の再チャレンジができる。   
（たとえ成功した場合でも、その後に再び大きな作業を続けるならツクールMVを開き直す事も検討されたい。）


※ 間違っても、同じプロジェクトを開いた状態で異なる作業を同時に進めてはいけない     
（それらを保存行為はゲーム制作状態の整合性を失う）   
※ あくまで、ツクールで同じデータを**読み込むだけ**は作業上問題ない、というだけである
